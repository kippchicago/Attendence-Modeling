# KIPP Chicago DRAFT Performance Dashboard


```{r options, echo=FALSE}
options(replace.assign=TRUE,width=60)
opts_chunk$set( 
  fig.align='center', 
  #dev='tikz', 
  fig.width=8, 
  fig.height=10.5, 
  fig.show='hold', 
  cache=FALSE, 
  par=TRUE,
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  autodepend=TRUE
)

opts_knit$set(progress=TRUE, concordence=TRUE)
```
```{r load_libraries}
setwd("~/Dropbox/Consulting/KIPP Ascend/Data Analysis/Dashboards/")



library(plyr)  #To manipulate data
library(reshape) #More data manipulation
library(ggplot2) #Graphics of grammer graphing
library(grid) #More Graphing
library(gridExtra) #better than par(mfrow=c(r,c)) for arranging ggplot2 and lattice graphics
library(lubridate) #for dealing with dates
library(xtable) #for pretty tables
library(RJDBC) #To get data form PowerSchool DB
library(RODBC) #To get data form PowerSchool DB
#source MAP helper functions
source("~/Dropbox/Consulting/KIPP Ascend/Data Analysis/MAP/Code/R/MAP_helper_functions.R")
```

```{r functions, cache=FALSE}
#This function matches cohort data to their respective grade years, based on H graduation year
align.cohort <- function (kippdata,cpsdata, collegeyear) {
  X<-data.frame()
  for(i in  collegeyear){
    y=i-4
    kipp<-rbind(subset(kippdata, Grade=="8th Grade" & Year==y), 
                subset(kippdata, Grade=="7th Grade" & Year==y-1),
                subset(kippdata, Grade=="6th Grade" & Year==y-2),
                subset(kippdata, Grade=="5th Grade" & Year==y-3)
    )
    cps<-rbind(subset(cpsdata, Grade=="8th Grade" & Year==y), 
               subset(cpsdata, Grade=="7th Grade" & Year==y-1),
               subset(cpsdata, Grade=="6th Grade" & Year==y-2),
               subset(cpsdata, Grade=="5th Grade" & Year==y-3)
    )
    
    cps<-subset(cps, variable=="Pct_ME" & (Subject=="Reading"|Subject=="Math"))
    x<-rbind(kipp, cps)
    #Need to reorder Grades level
    x$Grade<-ordered(x$Grade, 
                     levels=c("5th Grade", "6th Grade", "7th Grade", "8th Grade"))
    x$Class <- i
    X<-rbind(X,x)
  }
  X$Class<-factor(X$Class)
  X$Level<-factor(X$Level, levels=c("CPS", "KIPP Ascend"))
  X<-arrange(X, Level, Class, Subject, Year)
  X  
}

#This function draws line graphs for ISAT cohort analsyis 
plot.isat.cohort <- function (cohortdata, title=" ", type="line") {
  if(length(unique(cohortdata$Level))>1){
    kipp.colors <- c("#CFCCC1","#60A2D7")
  }
  if(length(unique(cohortdata$Level))==1){
    kipp.colors <- c("#60A2D7")
  }
  
  stripfillcol<-"#CFCCC1"
  
  
  p.blue.isat.cohort <- ggplot(cohortdata)
  
  if(type=="line"){
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_point(aes(x=Grade, y=value, group=Level, color=Level), size=5)
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_line(aes(x=Grade, y=value,  group=Level, color=Level), size=3) 
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_text(aes(x=Grade, y=value, label=round(value,0), group=Level), size=2,vjust=.5, hjust=.5)
  }
  if(type=="bar"){
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_text(aes(x=Grade, y=value, label=round(value,2), group=Level), position = position_dodge(width=1), vjust=-.5)
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_bar(aes(x=Grade, y=value,  group=Level, color=Level, fill=Level), stat="identity",position="dodge")
    p.blue.isat.cohort <- p.blue.isat.cohort + scale_fill_manual("",values=kipp.colors)
  }

    if(type=="point"){
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_point(aes(x=Grade, y=value,  group=Level, color=Level, fill=Level), stat="identity",position="dodge", size=10)
    p.blue.isat.cohort <- p.blue.isat.cohort + geom_text(aes(x=Grade, y=value, label=round(value,2), group=Level), position = position_dodge(width=1), vjust=-.5)
    p.blue.isat.cohort <- p.blue.isat.cohort + scale_fill_manual("",values=kipp.colors)
  }
  
  if(length(unique(cohortdata$Class))>1){
    p.blue.isat.cohort <- p.blue.isat.cohort + facet_grid(Class~Subject)  
    }
  if(length(unique(cohortdata$Class))==1){
    p.blue.isat.cohort <- p.blue.isat.cohort + facet_grid(.~Subject)  
    }
  p.blue.isat.cohort <- p.blue.isat.cohort + scale_color_manual("",values=kipp.colors)
  
 
  
  p.blue.isat.cohort <- p.blue.isat.cohort + theme(panel.margin = unit(1, "cm")) 
  
  
  p.blue.isat.cohort <- p.blue.isat.cohort + scale_x_discrete("")
   if(type=="line"){
    p.blue.isat.cohort <- p.blue.isat.cohort + scale_y_continuous("% Meets/Exceeds", limits=c(50,100))
  }
  else{p.blue.isat.cohort <- p.blue.isat.cohort + scale_y_continuous("% Meets/Exceeds", limits=c(0,105))}
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(panel.background = element_rect(colour = stripfillcol, fill = 'white', size = 1)) 
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(panel.border = element_rect(colour = stripfillcol)) 
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(panel.grid.minor = element_line(colour = stripfillcol, size=.4))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(panel.grid.major = element_line(colour = 'white', size=.5))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(strip.background = element_rect(fill=stripfillcol, colour = NA))
  
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(strip.text.x = element_text(size=15))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(strip.text.y = element_text(size=15, angle = 90))
  
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(legend.text = element_text(size=11))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(axis.title.y = element_text(size=13))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(axis.text.x = element_text(size=12))
  #p.blue.isat.cohort <- p.blue.isat.cohort + theme(axis.text.y = element_text(size=12))
  
  
  p.blue.isat.cohort <- p.blue.isat.cohort + theme(legend.position="bottom", legend.direction="horizontal")
  
  p.blue.isat.cohort
}

#Function to provide ordered id numbers to groups based on a given ranking criteria (v1)
orderid<-function(df,v1){
x<-arrange(df,v1)
x$OrderID<-c(1:nrow(x))
return(x)
}

#For Gant chart/Arrow diagrams comparing KIPP Network Schools
arrowdiagr<-function(data, t=" ", ranking="Fall", schoolname="KIPP Ascend Charter School"){
    X<-NA
    rvar<-NA
    X<-data
    comment(X)<-"X"  #provides a hacked means to use X in the paste on the next line
    if(ranking=="Fall"|ranking=="Spring"){
        
        rvar <- paste(comment(X),"$",ranking,".RIT",sep="") 
        
        X<-orderid(X,eval(parse(text=rvar))) 
        
        p <- ggplot(X, aes(x=Fall.RIT, y=OrderID)) + geom_segment(aes(xend=Spring.RIT, yend=OrderID, color=-posdiff),size=3, arrow=arrow(ends="last", length=unit(0.4, "cm"), type= "open", angle=20))
        p <- p + geom_segment(data=X[X$School_Display_Name==schoolname,],aes(x=Fall.RIT, y=OrderID, xend=Spring.RIT, yend=OrderID), color="green", size=4, arrow=arrow(length=unit(0.4, "cm"), type= "open", angle=20))
        p <- p + geom_text(aes(x=Spring.RIT-1, y=OrderID, label=Spring.RIT), size=2.5, hjust=1, vjust=.5,color="white", fontface="bold")
        p <- p + geom_text(aes(x=Fall.RIT+1.5, y=OrderID, label=Fall.RIT), size=2.5, hjust=1, vjust=.5,color="white", fontface="bold")
        p <- p  + scale_y_continuous(" ", breaks=X$OrderID, labels=X$School_Display_Name)
        p <- p + theme(axis.text.y = element_text(size=7, hjust=1))
        p <- p + theme(title=t)
        p <- p + theme(legend.position = "none")
        p <- p + scale_x_continuous("RIT Score")
    }
    
    if(ranking=="diff"){
        rvar <- paste(comment(X),"$",ranking,sep="") 
        
        X<-orderid(X,eval(parse(text=rvar))) 
        
        p <- ggplot(X, aes(x=0, y=OrderID)) + geom_segment(aes(xend=diff, yend=OrderID, color=-posdiff),size=3, arrow=arrow(ends="last", length=unit(0.4, "cm"), type= "open", angle=20))
        p <- p + geom_segment(data=X[X$School_Display_Name==schoolname,],aes(x=0, y=OrderID, xend=diff, yend=OrderID), color="green", size=3, arrow=arrow(length=unit(0.4, "cm"), type= "open", angle=20))
        p <- p + geom_text(aes(x=diff+1, y=OrderID, label=diff), size=3, hjust=-1, vjust=.5,color="white", fontface="bold")
        p <- p  + scale_y_continuous(" ", breaks=X$OrderID, labels=X$School_Display_Name)
        p <- p + theme(axis.text.y = element_text(size=7, hjust=1))
        p <- p + theme(title=t)
        p <- p + theme(legend.position = "none")
        p <- p + scale_x_continuous("Fall to Spring Change  in RIT Score")
    } 
    if(ranking=="PctGrowth"){
        rvar <- paste(comment(X),"$","Percent_Met_Growth_Target",sep="") 
        
        X<-orderid(X,eval(parse(text=rvar))) 
        
        p <- ggplot(X, aes(x=0, y=OrderID)) + geom_segment(aes(xend=Percent_Met_Growth_Target, yend=OrderID), color="blue",size=3)
        p <- p + geom_segment(data=X[X$School_Display_Name==schoolname,],aes(x=0, y=OrderID, xend=Percent_Met_Growth_Target, yend=OrderID), color="green", size=3)
        p <- p + geom_text(aes(x=Percent_Met_Growth_Target, y=OrderID, label=Percent_Met_Growth_Target), size=3, hjust=-1, vjust=.5,color="black", fontface="bold")
        p <- p  + scale_y_continuous(" ", breaks=X$OrderID, labels=X$School_Display_Name)
        p <- p + theme(axis.text.y = element_text(size=7, hjust=1))
        p <- p + theme(title=t)
        p <- p + theme(legend.position = "none")
        p <- p + scale_x_continuous("% Meeting Growth Target")
    }   
    p
}
```

```{r establsih_DB_connections, cache=FALSE}
drvr <- JDBC("oracle.jdbc.driver.OracleDriver", "/Users/chaid/Dropbox/JDBC Drivers/ojdbc5.jar","")
pscon <- dbConnect(drvr,"jdbc:oracle:thin:@10.160.29.47:1521:IL039","psnavigator","laidephy")
```

## Are we serving the children who need us?
```{r get_Enrollment_Data, cache=FALSE}
Enrollment<-dbGetQuery(pscon,"
                       
                      SELECT  sd.Student_Number,
                              sd.Name,
	                            sd.CURRENT_GRADE_LEVEL as Grade,
	                            sd.CURRENT_SCHOOL_ABBREVIATION as SchoolInitials,
	                            sd.GENDER,
	                            sd.ETHNICITY_NAME,
	                            sd.ETHNICITY_CODE,
	                            sd.MEMBERSHIPSHARE,
                              cs_iep.text_value AS SPED,
	                            cs_lii.char_value AS FRL,
	                            cs_lep.char_value AS ELL
                        FROM 
	                            PSSIS_STUDENT_DEMOGRAPHICS sd
	                      LEFT OUTER JOIN 
                              PVSIS_CUSTOM_STUDENTS cs_lii ON sd.STUDENT_NUMBER = cs_lii.STUDENT_NUMBER AND cs_lii.FIELD_NAME='IL_LII'
	                      LEFT OUTER JOIN 
                              PVSIS_CUSTOM_STUDENTS cs_iep ON sd.STUDENT_NUMBER = cs_iep.STUDENT_NUMBER AND cs_iep.FIELD_Name='IL_IEP'
	                      LEFT OUTER JOIN 
                              PVSIS_CUSTOM_STUDENTS cs_lep ON sd.STUDENT_NUMBER = cs_lep.STUDENT_NUMBER AND cs_lep.FIELD_Name='IL_LEP'
                       ")
```

```{r build_Enrollment_Table}

Enrollment$FRL<-as.numeric(Enrollment$FRL)
Enrollment$ELL<-as.numeric(Enrollment$ELL)
Enrollment$SPED<-as.numeric(Enrollment$SPED)

Enrollment.table<-ddply(Enrollment, .(GRADE), summarise, Enrolled=sum(MEMBERSHIPSHARE),PctMale=sum(GENDER=="M")/sum(MEMBERSHIPSHARE), PctFemale=sum(GENDER=="F")/sum(MEMBERSHIPSHARE),PctBlack=sum(ETHNICITY_CODE==2)/sum(MEMBERSHIPSHARE), PctLatino=sum(ETHNICITY_CODE==5)/sum(MEMBERSHIPSHARE),PctFRM=sum(FRL, na.rm=TRUE)/sum(MEMBERSHIPSHARE), PctELL=sum(ELL, na.rm=TRUE)/sum(MEMBERSHIPSHARE), PctSPED=sum(SPED, na.rm=TRUE)/sum(MEMBERSHIPSHARE)) 

attach(Enrollment)
Enrollment.table.totals<-data.frame(GRADE="Total",Enrolled=sum(MEMBERSHIPSHARE),PctMale=sum(GENDER=="M")/sum(MEMBERSHIPSHARE), PctFemale=sum(GENDER=="M")/sum(MEMBERSHIPSHARE),PctBlack=sum(ETHNICITY_CODE==2)/sum(MEMBERSHIPSHARE), PctLatino=sum(ETHNICITY_CODE==5)/sum(MEMBERSHIPSHARE),PctFRM=sum(FRL, na.rm=TRUE)/sum(MEMBERSHIPSHARE), PctELL=sum(ELL, na.rm=TRUE)/sum(MEMBERSHIPSHARE), PctSPED=sum(SPED, na.rm=TRUE)/sum(MEMBERSHIPSHARE))
detach(Enrollment)

Enrollment.table<-rbind(Enrollment.table, Enrollment.table.totals)

Enrollment.table[,c(3:9)]<-round(Enrollment.table[,c(3:9)]*100,0)

names(Enrollment.table)<-c("Grade", "Enrollment", "%\nMale", "%\nFemale", "%\nBlack", "%\nLatino", "%\nFRM", "%\nELL", "%\nSPED")
```

```{r Enrollement_table, fig.height=3.25, fig.width=8}
g<-grid.table(Enrollment.table, gpar.corefill=gpar(fill="#A7CFEE", alpha=.5, col="white"), h.odd.alpha=.25, gpar.colfill=gpar(fill="#60A2D7", col="white"),gpar.coltext=gpar(col="white", fontface="bold"), show.rownames=FALSE)
```




## Are our students staying with us?
```{r Mob_Attr_data, echo=FALSE, cache=TRUE}
df.attrition <- read.csv("/Users/chaid/Dropbox/Consulting/KIPP Ascend/Presentations/Charter Renewal/KAM_v_CPS_Mobility_Attrition_120910.csv")
df.attrition.melt<-melt(df.attrition)

colnames(df.attrition.melt)<-c("Variable", "Year", "value")


df.attrition.melt$Year<-sub("(X)(\\w+)","\\2" ,df.attrition.melt$Year)

df.attrition.melt$Year<-factor(df.attrition.melt$Year, levels=c("2004","2005","2006","2007","2008","2009","2010","2011","2012"))

df.attrition.melt$varType[grepl("Mobility",df.attrition.melt$Variable)]<-"Mobility"
df.attrition.melt$varType[grepl("Attrition",df.attrition.melt$Variable)]<-"Attrition"

df.attrition.melt$varType<-factor(df.attrition.melt$varType, levels=c("Mobility", "Attrition"))
df.attrition.melt$Variable<-factor(df.attrition.melt$Variable, levels=c( "CPS Mobility","KIPP Chicago Mobility","KIPP Network Attrition","KIPP Chicago Attrition"))
```

```{r Mob_Attr_Plot, echo=FALSE, fig.width=8, fig.height=4}
colours <- c( "#CFCCC1", "#60A2D7", "#8D8685", "#439539")



p <- ggplot(df.attrition.melt, aes(x=Year, y=value)) 
p <- p + geom_point(aes(color=Variable), size=5) 
p <- p + geom_line(aes(color=Variable, group=Variable), size=3) 

p <- p + facet_grid(varType~.)
p <- p + scale_color_manual("",values=colours)
p <- p + scale_y_continuous("")
p <- p + theme(
    panel.background = element_rect(fill = "transparent",colour = "#CFCCC1"), # or element_blank()
    panel.grid.major = element_line(colour="#CFCCC1"),
    panel.grid.minor = element_line(colour="transparent"),
    strip.background = element_rect(colour="#CFCCC1", fill="#CFCCC1"),

    plot.background = element_rect(fill = "transparent",colour = NA),
    axis.text.x = element_text(size=15),
     
    legend.position = "bottom",
    legend.text=element_text(size=12)
)
p

```

\newpage

## Are our students progressing and achieving academically?
```{r ISAT_Data_Prep, echo=FALSE, cache=FALSE}
#CPS Data
ISAT.CPS.historical.overall.data<-read.csv('/Users/chaid/Dropbox/Consulting/KIPP Ascend/Testing Analysis/ISAT/Results/isat_district_PRELIMINARY_2001_to_2012_mexc_yracross_by_grade_Without_ELL_reshaped_120806.csv')

names(ISAT.CPS.historical.overall.data)[4:15]<-c(2001:2012)

ISAT.CPS.historical.overall.melt<-melt(ISAT.CPS.historical.overall.data, id=c("Grade", "Subject", "Variable"))
names(ISAT.CPS.historical.overall.melt)[3:4]<-c("variable", "Year")

ISAT.CPS.historical.overall.melt<-ISAT.CPS.historical.overall.melt[,c(1,2,4,3,5)] #reorder columns to conform with earlier work
ISAT.CPS.historical.overall.melt$Level<-"CPS"

#This is KAMS data
ISAT.historical.overall.data<-read.csv('/Users/chaid/Dropbox/Consulting/KIPP Ascend/Testing Analysis/ISAT/Results/ISAT_historical_results_2012.csv')
ISAT.overall.melt<-melt(ISAT.historical.overall.data[,c("Grade","Year","Read_M_E","Math_M_E")],id=c("Grade","Year"))

#Add subject column and fix variable field 
ISAT.overall.melt$Subject[ISAT.overall.melt$variable=="Math_M_E"]<-"Math"
ISAT.overall.melt$Subject[ISAT.overall.melt$variable=="Read_M_E"]<-"Reading"
ISAT.overall.melt$variable <- "Pct_ME"
ISAT.overall.melt$Level <- "KIPP Ascend"

ISAT.plot.data<-align.cohort(ISAT.overall.melt, ISAT.CPS.historical.overall.melt, c(2013, 2014 ,2015, 2016, 2017, 2018))


p.isat<-plot.isat.cohort(subset(ISAT.plot.data, (Class==2015 | Class==2016 )&(Grade=="5th Grade"|Grade=="8th Grade")), type="line") +  ggtitle("ISAT KIPP vs CPS")
```
```{r MAP_Data_Prep, echo=FALSE, cache=TRUE}

con<-odbcConnect("kippchidata2") 
###Averages Data
MAP.math.averages.F10S12<-sqlQuery(con,"CALL GetMAPAverageByGradeByPeriod('Mathematics',NULL,'Fall10', 'Spring12');")
MAP.reading.averages.F10S12<-sqlQuery(con,"CALL GetMAPAverageByGradeByPeriod('Reading',NULL,'Fall10', 'Spring12');")
names(MAP.math.averages.F10S12)<-c("Grade", "Count", "Fall 10", "Spring 12")
names(MAP.reading.averages.F10S12)<-c("Grade", "Count", "Fall 10", "Spring 12")

MAP.math.averages.F10S12$Subject<-"Math"
MAP.reading.averages.F10S12$Subject<-"Reading"

MAP.reading.averages.F10S12 <- MAP.reading.averages.F10S12[MAP.reading.averages.F10S12$Grade!=1,]
MAP.math.averages.F10S12 <- MAP.math.averages.F10S12[MAP.math.averages.F10S12$Grade!=1,]
MAP.reading.averages.F10S12 <- MAP.reading.averages.F10S12[MAP.reading.averages.F10S12$Grade!=5,]
MAP.math.averages.F10S12 <- MAP.math.averages.F10S12[MAP.math.averages.F10S12$Grade!=5,]


MAP.averages.F10S12<-rbind(MAP.math.averages.F10S12,MAP.reading.averages.F10S12)

MAP.averages.F10S12.melt<-melt(MAP.averages.F10S12, id=c("Grade", "Subject"))
#MAP.averages.F10S12.melt<-MAP.averages.F10S12.melt[MAP.averages.F10S12.melt$variable!="Count"&MAP.averages.F10S12.melt$Grade!=5,] 
MAP.averages.F10S12.melt<-MAP.averages.F10S12.melt[MAP.averages.F10S12.melt$variable!="Count",]

MAP.averages.F10S12.melt$Level<-rep("KIPP Ascend",12)

#MAP.averages.F10S12.melt[MAP.averages.F10S12.melt$variable=="Fall 09","Grade"]<-MAP.averages.F10S12.melt[MAP.averages.F10S12.melt$variable=="Fall 09","Grade"]-1


MAP.NWEA.Averages.F10S12<-data.frame(Grade=rep(6:8,4))
MAP.NWEA.Averages.F10S12$Subject<-c(rep(c(rep("Math",3),rep("Reading",3)),2))
MAP.NWEA.Averages.F10S12$variable<-c(rep("Fall 10",6),rep("Spring 12",6))

MAP.NWEA.Averages.F10S12$value<-c(219.6,225.6,230.2,212.3,216.3,219.3,225.6,230.5,234.5,216.4,219.7,222.4)
MAP.NWEA.Averages.F10S12$Level<-rep("NWEA Norm",12)

#MAP.KIPPNational.Averages.F10S12<-data.frame(Grade=rep(5:8,4))
#MAP.KIPPNational.Averages.F10S12$Subject<-c(rep(c(rep("Math",4),rep("Reading",4)),2))
#MAP.KIPPNational.Averages.F10S12$variable<-c(rep("Fall 09",8),rep("Spring 11",8))

#MAP.KIPPNational.Averages.F10S12$value<-c(205.5,213.7, 222.8,230.5,200.6, 207.4,214,219.7,216.5,222.7,230.2,237.2,208.2,213,218.4,223.5)
#MAP.KIPPNational.Averages.F10S12$Level<-rep("KIPP National",16)

MAP.Averages.F10S12.plot.data<-rbind(MAP.averages.F10S12.melt,MAP.NWEA.Averages.F10S12)

MAP.Averages.F10S12.plot.data$Grade<-as.factor(MAP.Averages.F10S12.plot.data$Grade)
levels(MAP.Averages.F10S12.plot.data$Grade)<-c("6th","7th","8th")


###Quartile Data
matched.data<-sqlQuery(con, "CALL GetMAPQuartilesCohortMatchedByPeriod('Fall08', 'Spring12', 5, 8);") #gets matched data from DB

map.508812.cohort.melt<-melt(matched.data, id.var=c("Subject")) #melt to long format 

map.508812.cohort.melt$ExamDate[grepl("Fall", map.508812.cohort.melt$variable)]<-"Fall 2008"
map.508812.cohort.melt$ExamDate[grepl("Spring", map.508812.cohort.melt$variable)]<-"Spring 2012"

map.508812.cohort.melt$variable<-as.character(map.508812.cohort.melt$variable)
map.508812.cohort.melt$variable[grepl("_Q1", map.508812.cohort.melt$variable)]<-"1st Quartile"
map.508812.cohort.melt$variable[grepl("_Q2", map.508812.cohort.melt$variable)]<-"2nd Quartile"
map.508812.cohort.melt$variable[grepl("_Q3", map.508812.cohort.melt$variable)]<-"3rd Quartile"
map.508812.cohort.melt$variable[grepl("_Q4", map.508812.cohort.melt$variable)]<-"4th Quartile"
map.508812.cohort.melt$variable[grepl("N_Tested", map.508812.cohort.melt$variable)]<-"Number Tested"


#create center of x coordinates
map.508812.cohort.melt$x[map.508812.cohort.melt$ExamDate=="Fall 2008"]<-1
map.508812.cohort.melt$x[map.508812.cohort.melt$ExamDate=="Spring 2012"]<-2

#create y start and y end coordinates
plot.data<-ddply(map.508812.cohort.melt[map.508812.cohort.melt$variable!="Number Tested",c(1:5)],  .(Subject, ExamDate), transform, cum=cumsum(value))
plot.data<-ddply(plot.data,  .(Subject, ExamDate), transform, yend=cum+(50-cum[2]))
plot.data<-ddply(plot.data,  .(Subject, ExamDate), transform, ystart=c(50-cum[2],head(yend,-1)))

#drop any values less than 10 %

plot.data$label[plot.data$value>=8]<-plot.data$value[plot.data$value>=8]
```
```{r MAP_Quartile_Cohort_Plot, cache=FALSE}
kipp.colours <- c("#CFCCC1","#F4EFEB", "#BCD631", "#439539")

p <- ggplot(plot.data[plot.data$Subject=="Mathematics"|plot.data$Subject=="Reading",], 
    	aes(ExamDate, fill=variable, label=label)) 
p <- p + geom_rect(aes(x=ExamDate, xmin=x - 0.36, xmax = x + 0.36, ymin = ystart, ymax=yend))
p <- p + facet_grid(. ~ Subject)

p <- p + scale_fill_manual("",values=kipp.colours) 
p <- p + scale_x_discrete("")
p <- p + scale_y_continuous("")

p <- p +geom_text(aes(y=(yend+ystart)/2))
p <- p + geom_hline(y=50, color="#8D8685")
p <- p + theme(
    panel.background = element_rect(fill = "transparent",colour = NA), # or element_blank()
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA),
    strip.text.x = element_text(size=15),

    axis.ticks = element_blank(), 
   
    axis.text.y = element_blank(),
    legend.position = "none"
)

labels <- data.frame(Subject=c("Mathematics","Reading"),  #panel
                variable=c("1st Quartile","1st Quartile"),        #color
                 xtext=c(2,2.49),                            #x-coordinate of label
                ytext= c(50,50),                         #y-coordinate of label
                 Text=c("", "Grade\nLevel"))
# add labels to plot:
p.map.quartile<-p + geom_text(data=labels, aes(label=Text, x=xtext, y=ytext),  show_guide=FALSE, size=3, hjust=.5, color="#8D8685") 
```
```{r MAP_Averages_2year_Plot, echo=FALSE}
colours2 <- c("#CFCCC1","#60A2D7")
shapes <- c(18, 19)
xaxis <- c()

MAP.Averages.F10S12.cast<- cast(MAP.Averages.F10S12.plot.data, ...~ variable)

MAP.Averages.F10S12.cast$Grade1[MAP.Averages.F10S12.cast$Grade=="5th"]<-5
MAP.Averages.F10S12.cast$Grade1[MAP.Averages.F10S12.cast$Grade=="6th"]<-6
MAP.Averages.F10S12.cast$Grade1[MAP.Averages.F10S12.cast$Grade=="7th"]<-7
MAP.Averages.F10S12.cast$Grade1[MAP.Averages.F10S12.cast$Grade=="8th"]<-8
                                                                     
MAP.Averages.F10S12.cast$Grade2[MAP.Averages.F10S12.cast$Grade=="5th"]<-5.7
MAP.Averages.F10S12.cast$Grade2[MAP.Averages.F10S12.cast$Grade=="6th"]<-6.7
MAP.Averages.F10S12.cast$Grade2[MAP.Averages.F10S12.cast$Grade=="7th"]<-7.7
MAP.Averages.F10S12.cast$Grade2[MAP.Averages.F10S12.cast$Grade=="8th"]<-8.7

names(MAP.Averages.F10S12.cast)<-c("Grade", "Subject", "Level", "Fall09", "Spring11", "Grade1", "Grade2")

MAP.Averages.F10S12.cast$Level<-relevel(factor(MAP.Averages.F10S12.cast$Level), ref="NWEA Norm")

p.map.averages.slope <-ggplot(subset(MAP.Averages.F10S12.cast, Subject=="Reading"),aes(color=Level) ,stat=identity)
p.map.averages.slope <- p.map.averages.slope + geom_segment(aes(x=Grade1, y=Fall09, xend=Grade2, yend=Spring11),size=4)
p.map.averages.slope <- p.map.averages.slope + geom_point(aes(x=Grade1, y=Fall09,shape=Level), size=8)
p.map.averages.slope <- p.map.averages.slope + geom_text(aes(x=Grade1, y=Fall09,label=round(Fall09,0)), size=3.25, color="black")

p.map.averages.slope <- p.map.averages.slope + geom_point(aes(x=Grade2, y=Spring11,shape=Level), size=8)
p.map.averages.slope <- p.map.averages.slope + geom_text(aes(x=Grade2, y=Spring11,label=round(Spring11,0)), size=3.25, color="black")


#p.map.averages.slope <- p.map.averages.slope + facet_grid(.~Subject)
#p.map.averages.slope <- p.map.averages.slope + scale_color_manual("",values=colours2)

p.map.averages.slope <- p.map.averages.slope  + theme(legend.position="bottom", legend.direction="horizontal")
p.map.averages.slope <- p.map.averages.slope  + scale_color_manual("",values=colours2)
p.map.averages.slope <- p.map.averages.slope  + scale_shape_manual("", values=shapes) #need scale_color_manual AND scale_shape to have same title for one legend

p.map.averages.slope <- p.map.averages.slope  + scale_x_continuous("", breaks = c(6.35,7.35,8.35),labels=c("6th Grade", "7th Grade", "8th Grade"))
p.map.averages.slope <- p.map.averages.slope  + scale_y_continuous("RIT Score")

#p.map.averages.slope <- p.map.averages.slope  + theme(panel.background = element_rect(colour = 'gray', fill = 'white', size = 1)) 
#p.map.averages.slope <- p.map.averages.slope  + theme(panel.border = element_rect(colour = 'gray')) 
#p.map.averages.slope <- p.map.averages.slope  + theme(panel.grid.minor = element_line(colour = 'lightgray', size=.4))
#p.map.averages.slope <- p.map.averages.slope  + theme(panel.grid.major = element_line(colour = 'white', size=.5))
#p.map.averages.slope <- p.map.averages.slope  + theme(strip.text.x = element_text(size=15))
#p.map.averages.slope <- p.map.averages.slope  + theme(strip.background = element_rect(colour="#CFCCC1", fill="#CFCCC1"))
#p.map.averages.slope <- p.map.averages.slope  + theme(legend.text = element_text(size=11))
#p.map.averages.slope <- p.map.averages.slope  + theme(axis.title.y = element_text(size=13))
#p.map.averages.slope <- p.map.averages.slope  + theme(axis.text.x = element_text(size=12))
#p.map.averages.slope <- p.map.averages.slope  + theme(axis.text.y = element_text(size=12))
p.map.averages.slope <- p.map.averages.slope  + theme(legend.position="bottom", legend.direction="horizontal") + ggtitle("MAP Average Score By Class:\nFall 10 - Spring 12")
```

```{r graph_Academic_Progress, fig.width=8, fig.height=4}
blankPanel<-rectGrob(gp=gpar(col="white"))
grid.arrange(p.map.averages.slope, p.map.quartile, ncol=2)
```




## Are our alumni climbing the mountain to and through college?

```{r get_KTC_Selectivity_Data, cache=TRUE}
KIPP.Enrollments <- read.csv("~/Dropbox/Consulting/KIPP Ascend/Marketing Materials/Year End Update/2012.08.07_ChicagoProjectedEnrollments.csv")


KIPP.Enrollments$adj.SCR<-sub("(\\w+)([+|*])|(\\w+)([+*])", "\\1\\5" ,KIPP.Enrollments$SchoolCompetitivenessRanking)


KIPP.Enrollments$adj.SCR[KIPP.Enrollments$adj.SCR==""]<- "2 Year College"

KIPP.Enrollments$adj.SCR<-factor(KIPP.Enrollments$adj.SCR, levels=c("2 Year College", "Not Competitive", "Less Competitive", "Competitive", "Very Competitive", "Highly Competitive", "Most Competitive"))

KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$adj.SCR=="2 Year College"]<- "2-Year\nCollege"
KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$adj.SCR=="Not Competitive"|KIPP.Enrollments$adj.SCR=="Less Competitive"]<- "Non\nSelective"
KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$adj.SCR=="Competitive"]<- "Somewhat\nSelective"
KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$adj.SCR=="Very Competitive"]<- "Selective"
KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$adj.SCR=="Highly Competitive"|KIPP.Enrollments$adj.SCR=="Most Competitive"]<- "Very\nSelective"







selectivity.kipp.v.cps<-cbind(prop.table(table(KIPP.Enrollments$adj.Selectivity[KIPP.Enrollments$KIPP.HS.Class==2012])),(c(0.261370916,0.134529148,0.125560538,0.355861627,0.122677771))) #values from CPS.Selectivity.Calcs.xls derived from Potholes on the Road to College




colnames(selectivity.kipp.v.cps)<-c("KIPP Chicago", "CPS")


selectivity.plot.data<-melt(selectivity.kipp.v.cps)
colnames(selectivity.plot.data)<-c("Selectivity", "System", "value")


selectivity.plot.data$Selectivity<-factor(selectivity.plot.data$Selectivity, levels=c("2-Year\nCollege", "Non\nSelective", "Somewhat\nSelective", "Selective", "Very\nSelective"))
selectivity.plot.data$System<-factor(selectivity.plot.data$System, levels=c("CPS", "KIPP Chicago"))

selectivity.plot.data$Competitiveness[selectivity.plot.data$Selectivity=="2-Year\nCollege"|selectivity.plot.data$Selectivity=="Non\nSelective"]<-"Not\nSelective"
selectivity.plot.data$Competitiveness[selectivity.plot.data$Selectivity=="Somewhat\nSelective"|selectivity.plot.data$Selectivity=="Selective"]<-"Selective"
selectivity.plot.data$Competitiveness[selectivity.plot.data$Selectivity=="Very\nSelective"]<-"Very\nSelective"
```
```{r grap_KTC_selectivity, fig.width=4, fig.height=3.25}
competetive.plot.data<-ddply(selectivity.plot.data, .(System, Competitiveness), summarise, value=sum(value))


colours <- c("#CFCCC1", "#439539")

p <- ggplot(competetive.plot.data, aes(x = Competitiveness, y= value, fill=System)) + geom_histogram(stat="identity",position="dodge")
p <- p + geom_histogram(stat="identity",position="dodge")
p <- p + geom_text(aes(y=value, label=paste(round(value*100,0),"%",sep=""), ymax=.64) , position=position_dodge(width=.9),vjust=-.5)

p <- p + scale_fill_manual("",values=colours) 
p <- p + scale_x_discrete("")
p <- p + scale_y_continuous("")
p <- p + theme(
    panel.background = element_rect(fill = "transparent",colour = NA), # or element_blank()
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA),
    axis.text.x = element_text(size=15),
  
    axis.ticks = element_blank(), 
  axis.text.y = element_blank(),   
    legend.position = "bottom",
    legend.text=element_text(size=12)
)

p
```


\newpage

## Are we building a sustainable people model?

```{r fn_Net_Stacked, cache=TRUE}
net_stacked<-function(x) {
  
  ## x: a data.frame or list, where each column is a ordered factor with the same levels
  ## lower levels are presumed to be "negative" responses; middle value presumed to be neutral
  ## returns a ggplot2 object of a net stacked distribution plot
  
  require(ggplot2)
  
  ## Test that all elements of x have the same levels, are ordered, etc.
  all_levels <- levels(x[[1]])
  n <- length(all_levels)
  levelscheck <- all(sapply(x, function(y)
    all(c(is.ordered(y), levels(y) == all_levels))
  ))
  if(!levelscheck)
    stop("All levels of x must be ordered factors with the same levels")
  
  ## Reverse order of columns (to make ggplot2 output look right after coord_flip)
  x <- x[length(x):1]
  
  ## Identify middle and "negative" levels
  if(n %% 2 == 1)
    neutral <- all_levels[ceiling(n/2)]
  else
    neutral <- NULL
  
  negatives <- all_levels[1:floor(n/2)]
  positives <- setdiff(all_levels, c(negatives, neutral))
  
  ## remove neutral, summarize as proportion
  listall <- lapply(names(x), function(y) {
    column <- (na.omit(x[[y]]))
    out <- data.frame(Question = y, prop.table(table(column)))
    names(out) <- c("Question", "Response", "Freq")
    
    if(!is.null(neutral))
      out <- out[out$Response != neutral,]
    
    out
  })
  
  dfall <- do.call(rbind, listall)
  
  ## split by positive/negative
  pos <- dfall[dfall$Response %in% positives,]
  neg <- dfall[dfall$Response %in% negatives,]
  
  ## Negate the frequencies of negative responses, reverse order
  neg$Freq <- -neg$Freq
  neg$Response <- ordered(neg$Response, levels = rev(levels(neg$Response)))
  
  stackedchart <- ggplot() +
    aes(Question, Freq, fill = Response, order = Response) + 
    geom_bar(data = neg, stat = "identity") +
    geom_bar(data = pos, stat = "identity") + geom_hline(yintercept=0) +
    scale_y_continuous(name = "",
                       labels = paste0(seq(-40, 100, 20), "%"),
                       limits = c(-.4, 1),
                       breaks = seq(-.4, 1, .2)) +
    scale_fill_manual(limits = c(negatives, positives), values=c("#E27425", "#FEBC11", "#A7CFEE","#255694")) +
    coord_flip()
  
  stackedchart
}
```


```{r get_Q12, cache=TRUE}
Q12<-read.csv('/Users/chaid/Dropbox/Consulting/KIPP Ascend/Data Analysis/Q12/Q12_All_Responces_121113.csv')


Q12<-Q12[,c(1,5:16)]

quests<-names(Q12)[-1]


for(n in quests){
  Q12[,n] <- factor(x=Q12[,n], levels=c("Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"))
  Q12[,n] <- ordered(x=Q12[,n])
}


Q12.list<-as.list(Q12[,-1])
for(i in 1:length(Q12.list)){
  Q12.list[[i]]<-Q12.list[[i]][!is.na(Q12.list[[i]])]
  levels(Q12.list[[i]])<-c("Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree")
}

#Change list attributes to full question statements (yes, that is oxymoronic)
names(Q12.list)<-c(
                  "1. I know what is expected\nof me at work.",
                  "2. I have the materials and\nequipment needed to do my work.",
                  "3. At work I have the opportunity\nto do what I do best everyday.",
                  "4. In the last seven days I have\nreceived praise or recognition at work.",
                  "5. My supervisor, or someone at work,\ncares about me as a person.",
                  "6. Someone at work\nencourages my development.",
                  "7. At work, my opinions\nseem to matter.",
                  "8. The mission of my organization makes\nme feel like my job is important.",
                  "9. My coworkers are committed to\ndoing high-quality work.",
                  "10. I have a best\nfriend at work.",
                  "11. In the last six months someone at work\nhas talked to me about my progress.",
                  "12. In the last year I have had\nopportunities to learn and grow.")
```

```{r graph_Q12, fig.width=8, fig.height=4.0}
Q12.graph<-net_stacked(Q12.list)
Q12.graph + theme(legend.position=c(.5,-.13), legend.direction="horizontal")
```

## Are we building a sustainable financial model

\newpage

# DRAFT Details

## Are we serving the children who need us?

```{r get_Attendance_Data, cache=TRUE}
#Get Attendance data.  
# This SQL statement retrieves each enrolled student and their attendence status form PowerSchool 
# by date for a given dateThi sis a table with each student for each day with status for the day
Attendence<-dbGetQuery(pscon, "SELECT 
    m.schoolid, 
    m.grade_level,
  	m.calendardate, 
	m.STUDENT_NUMBER AS StudentID, 
  	m.lastfirst,
	m.Enrolled,
	a.Att_Code,
	a.Description as AttDescr,
	a.Presence_Status_CD,
	a.COURSE_CREDIT_POINTS,
	CASE 
		WHEN	a.Presence_Status_CD = 'Absent' THEN a.COURSE_CREDIT_POINTS 
		ELSE 0 
	END as Absent
FROM (
	SELECT
		psmd.SchoolID,  
		psmd.grade_level, 
		psmd.calendardate, 
		psmd.studentid,
		s.STUDENT_NUMBER,
		s.LASTFIRST, 
		1 as Enrolled  
	FROM PS_Membership_Defaults psmd
	LEFT JOIN students s ON psmd.StudentID = s.id
	Where 	calendardate >= '13-AUG-12'
		AND  calendardate <= '17-MAR-13'
) m
LEFT JOIN (
	SELECT 
		att.schoolid, 
		att.StudentID,
		att.Att_Date,
		attc.Att_Code,
		attc.Description,
		attc.Presence_Status_CD,
		attc.COURSE_CREDIT_POINTS
	FROM Attendance att
  	INNER JOIN Attendance_Code attc ON att.Attendance_CodeID = attc.ID
	WHERE 
		att.Att_Mode_Code = 'ATT_ModeDaily'
  		AND att.Att_Date >= '13-AUG-12'
  		AND att.Att_Date <= '17-MAR-13'
		AND (attc.att_code = 'A' OR attc.att_code = 'S' or attc.att_code = 'X' or attc.att_code = 'H')
) a
ON m.STUDENTID = a.studentid AND m.calendardate =a.Att_Date AND m.schoolID = a.schoolid
ORDER BY schoolid, grade_level, calendardate
")
```
```{r polish_Attendance, cache=FALSE}

Attendence$SchoolInitials[Attendence$SCHOOLID==7810]<-"KAMS"
Attendence$SchoolInitials[Attendence$SCHOOLID==78102]<-"KAPS"
Attendence$SchoolInitials[Attendence$SCHOOLID==400146]<-"KCCP"
Attendence$SchoolInitials<-factor(Attendence$SchoolInitials, levels=c("KAPS", "KAMS", "KCCP"))


#Summarize enrollments and absences by day



DailyEnrollAttend<-ddply(Attendence, .(SCHOOLID, CALENDARDATE), summarise, Enrolled=sum(ENROLLED), Absent=sum(ABSENT))

DailyEnrollAttendByGrade<-ddply(Attendence, .(SCHOOLID, GRADE_LEVEL, CALENDARDATE), summarise, Enrolled=sum(ENROLLED), Absent=sum(ABSENT))
#rename some columns (becuase ALL CAPS is annoying)

names(DailyEnrollAttend)<-c("SchoolID", "Date", "Enrolled", "Absent")
names(DailyEnrollAttendByGrade)<-c("SchoolID", "Grade","Date", "Enrolled", "Absent")


#transform dates
DailyEnrollAttend$Date<-ymd_hms(DailyEnrollAttend$Date)
DailyEnrollAttendByGrade$Date<-ymd_hms(DailyEnrollAttendByGrade$Date)


#Some quick daily stats
DailyEnrollAttend$Present<-DailyEnrollAttend$Enrolled-DailyEnrollAttend$Absent
DailyEnrollAttendByGrade$Present<-DailyEnrollAttendByGrade$Enrolled-DailyEnrollAttendByGrade$Absent

DailyEnrollAttend$PctAbsent<-DailyEnrollAttend$Absent/DailyEnrollAttend$Enrolled
DailyEnrollAttendByGrade$PctAbsent<-DailyEnrollAttendByGrade$Absent/DailyEnrollAttendByGrade$Enrolled

DailyEnrollAttend$PctPresent<-1-DailyEnrollAttend$PctAbsent
DailyEnrollAttendByGrade$PctPresent<-1-DailyEnrollAttendByGrade$PctAbsent

DailyEnrollAttend$PctPresentGTE95<-DailyEnrollAttend$PctPresent>=.95
DailyEnrollAttendByGrade$PctPresentGTE95<-DailyEnrollAttendByGrade$PctPresent>=.95

DailyEnrollAttend$Present96PctBenchMark<-.96*DailyEnrollAttend$Enrolled
DailyEnrollAttendByGrade$Present96PctBenchMark<-.96*DailyEnrollAttendByGrade$Enrolled

DailyEnrollAttend$WeekInYear<-week(DailyEnrollAttend$Date)
DailyEnrollAttendByGrade$WeekInYear<-week(DailyEnrollAttendByGrade$Date)

DailyEnrollAttend$WeekInSchoolYear<-(intv<-floor_date(DailyEnrollAttend$Date, unit="week")-min(floor_date(DailyEnrollAttend$Date, unit="week")))/dweeks(1)+1
DailyEnrollAttendByGrade$WeekInSchoolYear<-DailyEnrollAttendByGrade$WeekInYear - min(DailyEnrollAttendByGrade$WeekInYear) +1

DailyEnrollAttend$WeekOfDate<-floor_date(DailyEnrollAttend$Date, unit="week") + days(1) 
DailyEnrollAttendByGrade$WeekOfDate<-floor_date(DailyEnrollAttendByGrade$Date, unit="week") + days(1) 

#Long Week (of) label
DailyEnrollAttend$WeekOfDateLabel<-paste("Week of \n", month(DailyEnrollAttend$WeekOfDate,label=TRUE, abbr=TRUE), day(DailyEnrollAttend$WeekOfDate), sep=" ")
DailyEnrollAttendByGrade$WeekOfDateLabel<-paste("Week of \n", month(DailyEnrollAttendByGrade$WeekOfDate,label=TRUE, abbr=TRUE), day(DailyEnrollAttendByGrade$WeekOfDate), sep=" ")

DailyEnrollAttend$WeekOfDateLabel<-factor(DailyEnrollAttend$WeekInSchoolYear, labels=unique(DailyEnrollAttend$WeekOfDateLabel))
DailyEnrollAttendByGrade$WeekOfDateLabel<-factor(DailyEnrollAttendByGrade$WeekInSchoolYear, labels=unique(DailyEnrollAttendByGrade$WeekOfDateLabel))

#Short Week  Label
DailyEnrollAttend$WeekOfShortDateLabel<-paste(month(DailyEnrollAttend$WeekOfDate,label=TRUE, abbr=TRUE), day(DailyEnrollAttend$WeekOfDate), sep=" ")
DailyEnrollAttendByGrade$WeekOfShortDateLabel<-paste(month(DailyEnrollAttendByGrade$WeekOfDate,label=TRUE, abbr=TRUE), day(DailyEnrollAttendByGrade$WeekOfDate), sep=" ")


DailyEnrollAttend$WeekOfShortDateLabel<-factor(DailyEnrollAttend$WeekInSchoolYear, labels=unique(DailyEnrollAttend$WeekOfShortDateLabel))
DailyEnrollAttendByGrade$WeekOfShortDateLabel<-factor(DailyEnrollAttendByGrade$WeekInSchoolYear, labels=unique(DailyEnrollAttendByGrade$WeekOfShortDateLabel))


#add School Initials for graphics
DailyEnrollAttend$SchoolInitials[DailyEnrollAttend$SchoolID==7810]<-"KAMS"
DailyEnrollAttendByGrade$SchoolInitials[DailyEnrollAttendByGrade$SchoolID==7810]<-"KAMS"

DailyEnrollAttend$SchoolInitials[DailyEnrollAttend$SchoolID==78102]<-"KAPS"
DailyEnrollAttendByGrade$SchoolInitials[DailyEnrollAttendByGrade$SchoolID==78102]<-"KAPS"

DailyEnrollAttend$SchoolInitials[DailyEnrollAttend$SchoolID==400146]<-"KCCP"
DailyEnrollAttendByGrade$SchoolInitials[DailyEnrollAttendByGrade$SchoolID==400146]<-"KCCP"

DailyEnrollAttend$SchoolInitials<-factor(DailyEnrollAttend$SchoolInitials, levels=c("KAPS", "KAMS", "KCCP"))
DailyEnrollAttendByGrade$SchoolInitials<-factor(DailyEnrollAttendByGrade$SchoolInitials, levels=c("KAPS", "KAMS", "KCCP"))
#head(DailyEnrollAttend)
```
```{r Attendance_Summaries, cached=FALSE}
#calculate attendence rate by week by school
AttRateByWeekBySchool<-ddply(DailyEnrollAttend,.(SchoolInitials,WeekOfShortDateLabel), summarise, AttRate=sum(Present)/sum(Enrolled)*100)

AttRateYTDBySchool<-ddply(DailyEnrollAttend,.(SchoolInitials), summarise, AttRate=sum(Present)/sum(Enrolled)*100)

AttRateYTDBySchool$WeekOfShortLabel<-"YTD Each School"

AttRateByWeekBySchool.table<-cast(AttRateByWeekBySchool, WeekOfShortDateLabel ~ SchoolInitials)

AttRateYTDBySchool<-reshape(AttRateYTDBySchool, idvar="WeekOfShortLabel",timevar="SchoolInitials", direction="wide")
names(AttRateYTDBySchool)<-c("WeekOfShortDateLabel", "KAMS", "KAPS", "KCCP")




AttRateYTDRegion<-data.frame(WeekOfShortDateLabel="YTD Region", KAPS=sum(DailyEnrollAttend$Present)/sum(DailyEnrollAttend$Enrolled)*100, KAMS=NA,KCCP=NA)

AttRateYTDKAPSKAMS<-data.frame(WeekOfShortDateLabel="YTD KAPS & KAMS", KAPS=sum(subset(DailyEnrollAttend, SchoolInitials!="KCCP")$Present)/sum(subset(DailyEnrollAttend, SchoolInitials!="KCCP")$Enrolled)*100, KAMS=NA,KCCP=NA)
  
  
AttRateByWeekBySchool.table<-rbind(AttRateByWeekBySchool.table,AttRateYTDBySchool,AttRateYTDKAPSKAMS, AttRateYTDRegion)
AttRateByWeekBySchool.table[,c(2:4)] <- round(AttRateByWeekBySchool.table[,c(2:4)],1)  




names(AttRateByWeekBySchool.table)[1]<-"Week of" #a better column title
AttRateByWeekBySchool.xtable<-xtable(AttRateByWeekBySchool.table)


#Regional Attend by week
AttRateByWeek<-ddply(DailyEnrollAttend,.(WeekOfShortDateLabel), summarise, AttRate=sum(Present)/sum(Enrolled)*100)
names(AttRateByWeek)<-c("Week", "AttRate")

```

### Weekly Attendance, Region

```{r plot_Weekly_Attendance, fig.height=3}
ggplot(AttRateByWeek, aes(x=Week, y=AttRate)) + 
  geom_bar(fill="#255694") +  
  coord_cartesian(ylim = c(90,100)) + 
  geom_hline(yintercept=95, color="#E27425") +
  annotate("rect", xmin=10, xmax=14, ymin=97, ymax=98, alpha=.2) + 
  annotate("text", x=12, y=97.5, label=paste("YTD = ", round(AttRateYTDRegion[2],2), sep="")) + 
  theme(axis.text.x = element_text(angle=45, size=8))
```

### Daily Attendance by School

```{r fig_Daily_Attendence, fig.width=8, fig.height=3}
  ggplot(DailyEnrollAttend, aes(x=wday(Date), y=Enrolled)) + 
  geom_step(direction="hv", color="gray") + 
  geom_step(aes(y=Present), direction="hv") + 
  geom_step(aes(y=.95*Enrolled), direction="hv", color="green") + 
  scale_x_continuous(breaks = c(2,3,4,5,6), labels=c("M","T","W","R","F")) + #Change numberd week days to lettered
  facet_grid(SchoolInitials~WeekOfDateLabel, scales="free_y") +
  theme_bw()
```


\newpage

## Are our students staying with us?
  
```{r get_Transfer_data, cache=FALSE}
#all students enrolled on October 3, 2012
Enrolled.121003<-dbGetQuery(pscon, "SELECT
m.SchoolID,
s.student_number as StudentID,
s.first_name,
s.middle_name,
s.last_name,
m.grade_level,
s.ethnicity AS Race_ID,
s.gender,
s.dob,
s.entrydate,
s.SCHOOLENTRYDATE,
s.DISTRICTENTRYDATE,
s.EXITDATE,
s.exitcode,
s.EXITCOMMENT
FROM PS_Membership_Defaults m
JOIN STUDENTS s
ON m.studentid = s.id
WHERE m.calendardate = '03-OCT-12'
ORDER BY schoolid, grade_level
")

#all Students enrolled on Oct 31 who have exit dates prior to 6/14/2013

Xfers.HSR.1213<-subset(Enrolled.121003, ymd_hms(Enrolled.121003$EXITDATE)<ymd("13-06-14"))

#same as above but for prior year (i.e., 2010-11)

Enrolled.110930<-dbGetQuery(pscon, "SELECT
m.SchoolID,
s.student_number as StudentID,
s.first_name,
s.middle_name,
s.last_name,
m.grade_level,
s.ethnicity AS Race_ID,
s.gender,
s.dob,
s.entrydate,
s.SCHOOLENTRYDATE,
s.DISTRICTENTRYDATE,
s.EXITDATE,
s.exitcode,
s.EXITCOMMENT
FROM PS_Membership_Defaults m
JOIN STUDENTS s
ON m.studentid = s.id
WHERE m.calendardate = '30-SEP-11'
ORDER BY schoolid, grade_level
")


Xfers.HSR.1112<-subset(Enrolled.110930, ymd_hms(Enrolled.110930$EXITDATE)<ymd("12-09-30") & EXITCODE!="GR") #Remove graduated students

```

```{r prep_Transfer_data}


#xfer.total.monthly.by.school<-arrange(ddply(Xfers.HSR.1213, .(SCHOOLID, Month), summarise, N=length(Month)), Month)

#xfer.total.weekly.by.school<-arrange(ddply(Xfers.HSR.1213, .(SCHOOLID, Week), summarise, N=length(Week)), Week)

#xfer.total.cum.monthly<-ddply(xfer.total.monthly.by.school, .(SCHOOLID), transform, YTD=cumsum(N))

#xfer.total.cum.weekly<-ddply(xfer.total.weekly.by.school, .(SCHOOLID), transform, YTD=cumsum(N))

#extract month and date of transfers
  #need cumulative summation that handles NAs as 0s for next function to work
  cum.na <- function(x) { 
    x[which(is.na(x))] <- 0 
    return(cumsum(x)) 
  } 
transferplot.data.prep <- function (transfers.data, enrolled.data) {
  require(lubridate)
  require(reshape)
 
  transfers.data$Month<-lubridate::month(ymd_hms(transfers.data$EXITDATE), label=TRUE)
  transfers.data$Week<-lubridate::week(ymd_hms(transfers.data$EXITDATE))
  
  monthly.by.school<-arrange(ddply(transfers.data, .(SCHOOLID, Month), summarise, N=length(Month)), Month)
  
  cum.monthly<-ddply(monthly.by.school, .(SCHOOLID), transform, YTD=cumsum(N))
  
  cum.monthly$School[cum.monthly$SCHOOLID==78102]<-"KAPS"
  cum.monthly$School[cum.monthly$SCHOOLID==7810]<-"KAMS"
  cum.monthly$School[cum.monthly$SCHOOLID==400146]<-"KCCP"
  
  ####Need to build data fram that contains actual YTD, as well as 10% annual ceiling for each school.  Months need to 
  # start with October
  mons<-c("Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep")
  mons<-factor(mons, levels=mons, ordered=TRUE)
  
  #School<-c("KAPS", "KAMS", "KCCP")
  School<-unique(cum.monthly$School)
  School<-factor(School, levels=School)
  
cum.monthly$School<-factor(cum.monthly$School, level=School)
  
  
  
  redline<-ddply(enrolled.data, .(SCHOOLID), summarise, N.Enrolled=length(STUDENTID))
  redline$N.10pct<-redline$N.Enrolled*.1
  redline$line.month<-redline$N.10pct/12
  redline$School<-School
  redline<-redline[,c("School", "line.month")]
  
  
  
  
  xferplot.data<-expand.grid(Month=mons, School=School, Variable=c("Cumulative Transfers", "Ceiling"))
  xferplot.data<-merge(x=xferplot.data, y=redline, by="School",all.x=TRUE )
  names(xferplot.data)[4]<-"Value"
  xferplot.data$Value[xferplot.data$Variable=="Cumulative Transfers"]<-NA
  
  xfer.cums<-cum.monthly[,c("School", "Month", "N")]
  xfer.cums$Variable<-"Cumulative Transfers"
  xferplot.merge<-merge(xferplot.data, xfer.cums, by=c("School", "Month", "Variable"), all.x=TRUE)
  xferplot.merge$Value[!is.na(xferplot.merge$N)]<-xferplot.merge$N[!is.na(xferplot.merge$N)]
  xferplot.merge<-arrange(xferplot.merge[,c(1:4)], School, Variable, Month)
  
  cum.na <- function(x) { 
    x[which(is.na(x))] <- 0 
    return(cumsum(x)) 
  } 
  
  xferplot<-arrange(ddply(xferplot.merge, .(School, Variable), transform, CumVal= cum.na(Value)),School, Variable, Month)
  
  xferplot$Value[!is.na(xferplot$Value)]<-xferplot$CumVal[!is.na(xferplot$Value)]
  
  xferplot
}

xferplot.1213<-transferplot.data.prep(Xfers.HSR.1213, Enrolled.121003)
xferplot.1112<-transferplot.data.prep(Xfers.HSR.1112, Enrolled.110930)

```

```{r plot_Transfers, fig.width=12, fig.height=4}

t10pct.df<-data.frame(School=c("KAMS","KAPS", "KCCP"), Month="May", Variable="10% Limit", Value=c(30, 28,7))
tly.df<-data.frame(School=c("KAMS", "KAPS"), Month="May", Variable="Last Year", Value=c(12,5))

g.plot<-ggplot(data=subset(xferplot.1213, Variable=="Ceiling"), aes(x=Month, y=Value)) + 
  geom_line(aes(group=Variable), color="#E27425") + 
  geom_line(data=subset(xferplot.1112, Variable!="Ceiling"), aes(x=Month, y=CumVal, group=Variable), color="#17345B") + 
  geom_bar(data=subset(xferplot.1213, Variable!="Ceiling"), aes(x=Month, y=Value), fill="#439539", width=.5) + 
  facet_grid(School~., scale="free_y") +
  geom_text(data=t10pct.df, aes(label=Variable), color="#E27425", size=3.7) + 
  geom_text(data=tly.df, aes(label=Variable), color="#17345B", size=3.7)


#table of Transfers by schoool 

Xfersreasons<-data.frame(EXITCODE=c(1:11,99),Reason=c("Dropped Out", "Moved", "Transport", "Expelled", "Behavior/Discipline", "Academics", "Avoid Retention", "Special Needs", "Other", "Don't Know", "Xfer Other KIPP", "DNA"))

Xfer.table<-merge(Xfers.HSR.1213,Xfersreasons, all.x=TRUE)
Xfer.table<-cast( ddply(Xfer.table, .(Reason, SCHOOLID), function(df)c(N=nrow(df))), Reason~SCHOOLID, margins=TRUE, fun.aggregate=sum)
names(Xfer.table)<-c("Tranfer Reason", "KAMS", "KAPS", "KCCP", "Region")
levels(Xfer.table[,1])[13]<-"Total"
Xfer.table<-Xfer.table[,c("Tranfer Reason", "KAPS", "KAMS", "KCCP", "Region")]
g.tbl<-tableGrob(xtable(Xfer.table), show.rownames=FALSE)

#Combine plot
grid.newpage()
grid.arrange(g.plot, g.tbl, widths=c(.6,.4),ncol=2)
```

## Are our students progressing and achieving academically?

```{r prep_ANet_Data, echo=FALSE, cache=TRUE}

#Get data from CSV file compiled from ANet reporting website
ANet.A3<-read.csv('/Users/chaid/Dropbox/Consulting/KIPP Ascend/Data Analysis/ANet/Results/ANET_Results_A1A2_130225.csv')
kippcols=c("#439539", "#BCD631", "#CFCCC1")


ANet.A3$School<-factor(ANet.A3$School, levels=c("KAP/MS", "KCCP", "Anet"), labels=c("KAP/MS", "KCCP", "ANet"))
ANet.A3$Subject<-factor(ANet.A3$Subject, levels=c("Math", "ELA"))
ANet.A3$Grade<-factor(ANet.A3$Grade, levels=c(2,5,6,7,8))
ANet.A3$Test<-factor(ANet.A3$Test, levels=c("A1","A2","A3", "A1A2", "A1A2A3"), labels=c("A1", "A2", "A3", "A1 & A2 Combined", "A1-A3 Combined"))
```
```{r prep_ANet_overunder, echo=FALSE, cache=TRUE}
#Create plot showing performance above or below average

ANet.A3.melt<-melt(ANet.A3)

ANet.Percent.cast<-cast(ANet.A3.melt, Test + Grade + Subject ~ School + variable, subset=variable=="Percent")
names(ANet.Percent.cast)<-c("Test", "Grade", "Subject", "Ascend", "Create", "ANet")

ANet.Percent<-within(ANet.Percent.cast, {
  KAPMS<-(Ascend - ANet)
  KCCP <- (Create-ANet)
  variable<-"Percent" 
       })

ANet.Sixty.cast<-cast(ANet.A3.melt, Test + Grade + Subject ~ School + variable, subset=variable=="Pct60Above")
names(ANet.Sixty.cast)<-c("Test", "Grade", "Subject", "Ascend", "Create", "ANet")

ANet.Sixty<-within(ANet.Sixty.cast, {
  KAPMS<-Ascend - ANet 
  KCCP <- Create-ANet
  variable<-"Pct60Above" 
       })

ANet.Diffs<-rbind(ANet.Percent, ANet.Sixty)

ANet.Diffs<-ANet.Diffs[,-c(4:6)]

ANet.Diffs.melt<-melt(as.data.frame(ANet.Diffs), measure=c("KCCP", "KAPMS"), variable_name="School", na.rm=TRUE)#use as.data.frame() trick to strip deleted melt info per hadely's suggestion at https://stat.ethz.ch/pipermail/r-help/2009-January/185755.html

ANet.Diffs.melt$Pos<-ANet.Diffs.melt$value>0


ANet.Diffs.melt$School<-factor(ANet.Diffs.melt$School, levels=c("KAPMS", "KCCP"), labels=c("KAP/MS", "KCCP"))
ANet.Diffs.melt$Subject<-factor(ANet.Diffs.melt$Subject, levels=c("Math", "ELA"))
ANet.Diffs.melt$Grade<-factor(ANet.Diffs.melt$Grade, levels=c(2,5,6,7,8))
ANet.Diffs.melt$Test<-factor(ANet.Diffs.melt$Test, levels=c("A1","A2","A3","A1A2", "A1A2A3"), labels=c("A1", "A2", "A3", "A1 & A2 Combined", "A1-A3 Combined"))
```

```{r plot_overunder, fig.height=4.5, fig.width=10, echo=FALSE, warning=FALSE}

Anet.sub<-subset(ANet.Diffs.melt,variable=="Percent" & School!="KCCP" & Test!="A1 & A2 Combined")

ggplot(Anet.sub, aes(x=as.factor(Grade), y=value)) +
  geom_bar(aes(fill=Pos), position="dodge", stat="identity" ) + 
  geom_text(data = subset(Anet.sub, value>=0), aes(y=value+2, label=round(value), color=Pos), vjust=0) +
    geom_text(data = subset(Anet.sub, value<0), aes(y=value-2, label=round(value), color=Pos), vjust=1) +
  geom_hline(yintercept=0, show_guide=T) +
  facet_grid(Subject ~ Test) + 
  scale_fill_manual(values=c("#E27425","#439539"), guide="none") +  
  scale_colour_manual(values=c("#E27425","#439539"), guide="none") +
  labs(x="Grade", y="Points Above/Below Network Average") +
  theme_bw() + 
  expand_limits(y=c(-10,25)) +   
  ggtitle("ANet Interim 3: Percentage Points Above/Below Network Average")
```

```{r plot_overunder_by_grade, fig.height=4.5, fig.width=10}
ggplot(subset(ANet.Diffs.melt,variable=="Percent" & School!="KCCP" & Test!="A1 & A2 Combined" & Test!="A1-A3 Combined"), aes(x=as.factor(Test), y=value)) +    geom_text(data = subset(ANet.Diffs.melt,variable=="Percent" & School!="KCCP" & Test!="A1 & A2 Combined" & Test!="A1-A3 Combined" & value>=0), aes(y=value+2, label=round(value), color=Pos), vjust=0) + geom_line(aes(x=as.numeric(Test))) + 
    geom_point(aes(color=Pos), size=5) + 
    geom_text(data = subset(ANet.Diffs.melt,variable=="Percent" & School!="KCCP" & Test!="A1 & A2 Combined" & Test!="A1-A3 Combined" & value<0), aes(y=value-2, label=round(value), color=Pos), vjust=1) +
    geom_hline(yintercept=0, show_guide=T) +
    facet_grid(Subject ~ Grade) + 
    scale_fill_manual(values=c("#E27425","#439539"), guide="none") +  
    scale_colour_manual(values=c("#E27425","#439539"), guide="none") +
    labs(x="Interim Assessment", y="Points Above/Below Network Average") +
    theme_bw() + 
    expand_limits(y=c(-10,25)) +   
    ggtitle("ANet Interim 3: Percentage Points Above/Below Network Average")
```

## Interim 1-3 Combined.  Average Score by grade and subject.
```{r plot_Anet3_Combined, fig.height=4.5, fig.width=10, echo=FALSE, warning=FALSE}

ANet.A3.combined.plot<-ggplot(subset(ANet.A3, Test=="A1-A3 Combined"), aes(x=Grade, y=Percent)) + 
  geom_text(aes(y=Percent+1,label=Percent, color=School), position = position_dodge(width=1), vjust=0, size=6) +
  geom_bar(aes(fill=School), position="dodge", stat='identity') + 
  facet_grid(Subject ~ .) +
  scale_fill_manual("",values=kippcols) +
  scale_colour_manual("",values=kippcols) +
  ylim(0,80) + 
  theme_bw() + 
  theme(legend.position="bottom") +
  ggtitle("ANet Interims 1,2 & 3 - Combined Results")
  
ANet.A3.combined.plot 
```
This shows the average of student scores, which themselves are the percent of question answered correctly.
```{r plot_Anet1_2_3, echo=FALSE,fig.height=4.5, fig.width=10}
ts<-5

ANet.A3.plot<-ggplot(subset(ANet.A3, Test!="A1 & A2 Combined" & School!="KCCP"), aes(x=Grade, y=Percent)) + 
  geom_text(aes(y=Percent+1,label=Percent, color=School), position = position_dodge(width=1), vjust=0, size=ts) +
  geom_bar(aes(fill=School), position="dodge", stat='identity') + 
  facet_grid(Subject ~ Test) +
  scale_fill_manual("",values=kippcols) +
  scale_colour_manual("",values=kippcols) +
  ylim(0,85) + 
  theme_bw() + 
  theme(legend.position="bottom") + 
  ggtitle("ANet Interims  - Percent of Questions Correct")
  
ANet.A3.plot 
```
This chart shows the *percent of students* earning a 60% or better.  
```{r plot_Anet1_2_3_60plus, echo=FALSE, fig.height=4.5, fig.width=10}
ANet.A3.pct60.plot<-ggplot(subset(ANet.A3, Test!="A1 & A2 Combined" & School!="KCCP"), aes(x=Grade, y=Pct60Above)) + 
  geom_text(aes(y=Pct60Above+1,label=Pct60Above, color=School), position = position_dodge(width=1), vjust=0, size=ts) +
  geom_bar(aes(fill=School), position="dodge", stat='identity') + 
  facet_grid(Subject ~ Test) +
  scale_fill_manual("",values=kippcols) +
  scale_colour_manual("",values=kippcols) +
  ylim(0,105) + 
  theme_bw() + 
  theme(legend.position="bottom") +
  ylab("Percent > 60%") +
  ggtitle("ANet Interims  - Percent of Students w/ Scores > 60 Percent")
  
ANet.A3.pct60.plot 

```
## Are our alumni climbing the mountain to and through college?
```{r prep_ktc_detail_data, fig.width=12, fig.height=6}

KTC.detail<-expand.grid(Class=c(2011,2012), Network=c("KIPP Chicago", "KIPP Network"),Metric=c("HS Graduation", "College Matriculation", "College Persistence"))


KTC.detail$Percent<-c(96,86,91,83,88,76,81,69,86,76,81,69)


KTC.lt.hline<-data.frame(Metric=c("HS Graduation", "College Matriculation"), Percent=c(93,83), Network="LT Avg", Class=2012.3)

kippcols=c("#439539", "#CFCCC1")

ggplot(KTC.detail, aes(x=Class, y=Percent)) + 
  geom_bar(aes(fill=Network), position="dodge", stat="identity") +
  geom_hline(aes(yintercept=Percent), KTC.lt.hline, show_guide=FALSE, color="#E27425") +
  geom_text(aes(y=Percent+1,label=Percent, color=Network), position = position_dodge(width=1), vjust=0, size=6) +
 geom_text(data=KTC.lt.hline, aes(label=paste("Historic Network Avg = ", Percent, "%",sep="")), color="#E27425", vjust=0) +
  scale_fill_manual(values=kippcols) +
  scale_colour_manual(values=kippcols) +
  facet_grid(Metric~.) +
  coord_cartesian(ylim = c(40, 105)) +
  theme_bw() + theme(legend.position="bottom")

```
